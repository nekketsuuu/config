#!/bin/bash

# Show the first public key for the current git remote.
# This script is meant to be used with git config gpg.ssh.defaultKeyCommand.

domain="$1"

set -eu -o pipefail

if [ -z "$domain" ]
then
  url="$(git remote get-url origin)"
  # SSH format: ssh://git@github.com/repo.git → github.com
  domain=$(echo "$url" | grep -E 'ssh://' | sed 's|.*@\([^/]*\)/.*|\1|' || true)
  if [ -z "$domain" ]
  then
    # HTTPS format: https://github.com/user/repo.git → github.com
    domain=$(echo "$url" | grep -E 'https://' | sed 's|.*://\([^/]*\).*|\1|' || true)
  fi
  if [ -z "$domain" ]
  then
    echo "Error: Unable to extract domain from $url" >&2
    exit 1
  fi
fi

key_file="$(ssh -G "$domain" | grep '^identityfile' | awk '{print $2}' | head -1)"
# workaround: Expand ~ to $HOME (tenuki)
pub_key_file="${key_file/#\~/$HOME}.pub"

if [ -f "$pub_key_file" ]
then
  echo "key::$(cat "$pub_key_file")"
  exit 0
else
  echo "Error: Public key not found at $pub_key_file" >&2
  exit 1
fi
